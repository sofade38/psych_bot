import requests
from telegram import Update
from telegram.ext import Application, CommandHandler, CallbackContext


async def check_slots(context: CallbackContext):
    chat_id = context.job.data  # Извлекаем ID чата из контекста задания
    url = 'https://telemed-patient-bff.sberhealth.ru/api/showcase/web/v1/providers/62/doctors/2655999/specialties/psychologist/slots'
    response = requests.get(url)

    if response.status_code == 200:
        try:
            data = response.json()
            slots = data['slots']

            if len(slots) > 0:
                await context.bot.send_message(chat_id=chat_id, text="У психолога появились свободные слоты!")
            else:
                await context.bot.send_message(chat_id=chat_id, text="У психолога пока нет свободных слотов.")
        except Exception as e:
            print(f"Ошибка при обработке ответа: {e}")
            await context.bot.send_message(chat_id=chat_id, text="Произошла ошибка при обработке данных.")
    else:
        await context.bot.send_message(chat_id=chat_id,
                                       text=f'Ошибка при получении данных. Код статуса: {response.status_code}')


# Команда для запуска проверки слотов
async def start_checking(update: Update, context: CallbackContext):
    chat_id = update.effective_chat.id
    context.job_queue.run_repeating(check_slots, interval=10, first=0, data=chat_id, name=str(chat_id))
    await update.message.reply_text("Проверка слотов запущена. Я буду сообщать вам об их наличии каждые 15 минут.")


# Команда для остановки проверки слотов

async def stop_checking(update: Update, context: CallbackContext):
    chat_id = str(update.effective_chat.id)
    job = context.job_queue.get_jobs_by_name(chat_id)
    job.schedule_removal()
    await update.message.reply_text("Проверка слотов остановлена.")


# Токен вашего бота
TOKEN = '7826213914:AAHMhg9Me0ZdEEFOIK9pAXJniv7WOWqxr7U'

if __name__ == '__main__':
    application = Application.builder().token(TOKEN).build()

    # Добавляем обработчики команд
    application.add_handler(CommandHandler('start_checking', start_checking))
    application.add_handler(CommandHandler('stop_checking', stop_checking))

    # Запускаем бота
    application.run_polling()